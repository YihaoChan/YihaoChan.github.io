---
title: Vim的系统剪贴板的奇妙发现
categories: Operation System
tags: Vim
abbrlink: 10c2209c
date: 2020-12-11 16:34:35
---

学习Vim的时候，接触了```yy```和```p```的Vim窗口内部复制与粘贴命令。但是有一次，在Vim中执行```yy```命令后，关闭Vim，想把复制到的整一行文字粘贴到已经关闭Vim了的终端上时，却一直无法粘贴，怎么按粘贴快捷键都是空白。对于这个问题有点搞不懂，就上网搜了一下，原来想要在Vim以外的进程上粘贴东西的时候，需要用到Vim里的**系统剪贴板**。但是，这个Vim的"系统"剪贴板，也不是真正的操作系统的"系统"剪贴板。

<!--more-->

P.S. 以下过程均以Ubuntu 18.04.5操作系统为例进行演示。

## 1. 查看Vim是否支持系统剪贴板

在终端中输入```vim --version | grep clipboard```，观察**clipboard**选项前的符号：如果为 **-** 号，说明当前的Vim不支持系统剪贴板，需要先在终端执行```sudo apt install vim-gnome```，之后再次执行```vim --version | grep clipboard```，可以看到**clipboard**选项前的符号为 **+** 号，表示当前的Vim已经支持系统剪贴板。

![](/images/Vim的系统剪贴板的奇妙发现/Vim开启Clipboard.png)

## 2. 查看Linux系统的系统剪贴板内容

执行```sudo apt install xclip```安装xclip，再执行```xclip -o```命令，就可以查看当前Linux系统的系统剪贴板内容。

e.g. 在终端上打印一串字符：

![](/images/Vim的系统剪贴板的奇妙发现/终端打印内容.png)

然后用鼠标选中，按下```ctrl + shift + c```复制：

![](/images/Vim的系统剪贴板的奇妙发现/终端复制内容.png)

执行```xclip -o```命令查看系统剪贴板内容：

![](/images/Vim的系统剪贴板的奇妙发现/查看系统剪贴板.png)

此时可以看到，用户手动复制到了Linux的系统剪贴板的内容已经通过```xclip -o```成功显示。

## 3. 通过Vim的系统剪贴板将内容复制到Vim以外的地方

使用Vim打开任意一个文件，按下```Esc```进入命令模式，再执行```"+yy```命令复制当前一整行至Vim的系统剪贴板，执行```:reg```查看Vim的寄存器，可以看到Vim的系统剪贴板寄存器("+寄存器)已存放我们刚才复制的一整行内容。

![](/images/Vim的系统剪贴板的奇妙发现/Vim系统剪贴板寄存器.png)

之后**不要退出**Vim窗口，打开任意一个Vim以外的地方，快捷键``` ctrl + v ```，可以看到在Vim中复制的内容已经粘贴到Vim以外的地方。

![](/images/Vim的系统剪贴板的奇妙发现/复制到Vim以外.png)

在Vim中执行```:wq```退出Vim窗口，再到另一个地方按下快捷键```ctrl + v```，可以发现，**什么都没有**。

当我好几次重复上述过程都发现，没有办法在关闭Vim的情况下粘贴已经在Vim中复制的内容的时候，我就开始有点怀疑了：Vim的系统剪贴板，到底是不是真正的"系统"剪贴板？

## 4. 结合xclip -o仔细观察

在终端再次打印(Test for system clipboard.)并手动复制，然后执行```xclip -o```，可以看到Linux的系统剪贴板内容此时就是我们复制的内容。

![](/images/Vim的系统剪贴板的奇妙发现/再次xclip.png)

而当我们在Vim中通过命令模式执行```"+yy```之后，我们可以的确可以将Vim中复制的内容原封不动地粘贴到Vim以外的地方。**但是，**```xclip -o```查看到的却是我们之前在Vim以外的地方手动复制的内容。

!["Test for Vim clipboard."是我从Vim中复制并粘贴到终端上的内容，而"Test for system clipboard."是我之前手动在终端上复制的内容。](/images/Vim的系统剪贴板的奇妙发现/两次对比.png)

在Vim中执行```:wq```退出Vim窗口，再在终端按下快捷键```ctrl + shift +v```，什么都没有。但是执行```xclip -o```却还是查看到了之前我手动复制的内容。

!["空行"是我关掉Vim后按下粘贴快捷键后显示的内容，而"Test for system clipboard."是我之前手动在终端上复制的内容。](/images/Vim的系统剪贴板的奇妙发现/xclip看到之前.png)

## 5. 浅显通俗的猜想与拙见

由此可见，Vim的"系统"剪贴板，并没有真正将内容拷贝到Linux的系统剪贴板上，当Vim这个进程被关闭了之后，Vim的"系统"剪贴板上的东西就会全部消失，并且也让Linux的系统剪贴板上的内容消失。

在与同学分享并讨论这个情况之后，我们用通俗的猜想去理解这个现象：在Vim中执行```"+yy```命令后，VIm对Linux的粘贴快捷键进行了"劫持"。

在Vim进程未关闭的时候，我们去往Vim以外的任何地方进行粘贴，粘贴的内容都是保存在Vim的系统剪贴板寄存器中的内容，并且此时我们的粘贴快捷键粘贴的内容，已经和我们Linux的系统剪贴板上的内容**没有任何关系**。相当于，在Vim收到了```"+yy```这个命令后，Vim"劫持"掉了我们Linux系统的粘贴快捷键，不管我们粘贴什么东西，都是来自于Vim的系统剪贴板寄存器。而在Vim进程关闭之后，自然Vim的寄存器随着Vim进程的关闭而消失，所以Vim的系统剪贴板寄存器中的内容被清空。而此时由于Linux的粘贴快捷键在之前已经被Vim"劫持"，并且Vim在关闭进程的时候也**没有归还**Linux的粘贴快捷键内容，因此，在Vim关闭后，不管我们怎么敲粘贴快捷键，都是一片空白。但```xclip -o```还是查看到了我们在Vim中复制之前的Linux系统剪贴板内容，可我们已经和它无缘。

## 6. 尝试将内容复制到Linux的系统粘贴板

那么，如何真正做到在Vim中复制内容之后，即使在将Vim关闭之后，也能在其他地方粘贴呢？

### 6.1 尝试1：进入Vim的可视模式

在Vim中按下```Esc```进入命令模式，再按下```v```进入可视模式。按左右方向键对字符进行选中，再按下y键进行复制。关闭Vim，敲下粘贴快捷键，**一片空白。**

结论：可视模式无法将Vim中的内容复制到Linux的系统剪贴板。

### 6.2 尝试2：让Vim进程进入后台

在Vim中按下```Esc```进入命令模式，再执行```"+yy```命令复制当前一整行至Vim的系统剪贴板，按下Linux系统快捷键```ctrl + z```将Vim进程放到后台。此时Vim进程已经被放到后台，并处于suspended(暂停)状态。

执行```bg %1```命令让Vim进程在后台运行，可以看到Vim进程在continued状态之后还是切换到了suspended状态，执行```jobs```命令，Vim进程还是处于suspended状态。在任意一处按下Linux系统的粘贴快捷键，依旧是**一片空白。**

![](/images/Vim的系统剪贴板的奇妙发现/将Vim放到后台bg.png)

结论：将Vim进程放到后台，只能让Vim处于suspended状态，且无法让在Vim中的复制到Vim的系统剪贴板的内容进入Linux的系统剪贴板。

### 6.3 尝试3：进入Vim的插入模式

在Vim中按下```Esc```进入命令模式，再按下```i```进入插入模式。用**鼠标**手动选中内容，并按下Linux系统的复制快捷键```ctrl + shift + c```复制。

![](/images/Vim的系统剪贴板的奇妙发现/插入模式手动复制.png)

关闭Vim，敲下Linux的粘贴快捷键，**成功**将Vim中内容复制到Vim以外。此时执行```xclip -o```命令，可以看到Linux的系统剪贴板也显示我们在Vim中通过插入模式用鼠标选中并复制的内容。

![](/images/Vim的系统剪贴板的奇妙发现/插入模式手动复制-关掉后粘贴.png)

结论：要想在关掉VIm之后，将在Vim中复制的内容送到Linux的系统剪贴板，需要在Vim中切换到插入模式，并用鼠标手动选中内容，再按下Linux系统的复制快捷键。之后即使关掉Vim，也能将内容粘贴到任意地方。**但是**，这不就违背了Vim的核心思想——"只通过键盘操作，解放鼠标操作"了吗？(滑稽)。

或许有人会说：在不关掉Vim的时候进行粘贴不就好了嘛。假设我需要把这部分复制的内容粘贴很多次，而且并非同时粘贴，可能是间断性不定时地粘贴，那么如果采用Vim的"系统"剪贴板进行复制粘贴的话，就意味着我需要一直开着这个Vim进程，不能人为/意外地关闭它。对于我这种强迫症来说，是接受不了的。对于不会用到的东西/进程，我一定选择丢弃~

## 7. 小结

在发现这个现象后，我真的感叹开发Vim的这个功能的开发人员太太太聪明了！虽然...ta给我们带来了一些麻烦。所以，以后要将Vim中的内容复制到Vim外面的时候，切记**不能**退出Vim，否则怎么粘贴都没有用。如果在打开Vim之前用户自己有手动复制过某内容的话，那么在Vim中复制内容到Vim的系统剪贴板并退出Vim之后，也不会保留打开Vim之前复制的内容，只剩下一片空白。如果真要在关闭Vim之后还能获得在Vim中复制的内容，办法就是切换到Vim的插入模式，用鼠标进行选中和复制，之后不管关闭Vim与否，都可以进行粘贴。

至于我们的猜想到底对不对，等我有能力读懂Vim的源代码之后再下定论。